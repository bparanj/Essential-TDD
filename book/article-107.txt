Stripe Recurring Billing







Questions
==========
-----------

1. Subscription happens in real-time? Can it be done in the background? READ : Mastering Modern Payments.

Building Links
---------------

1. Reply to comment on Railscasts on how to test Stripe integration:http://railscasts.com/episodes/288-billing-with-stripe?view=commentshttps://gist.github.com/justinthiele/1307748

Notes
-------

1. Stripe tutorial (https://stripe.com/docs/tutorials/forms) which uses https://js.stripe.com/v2/ and has some differences, including the 'data-stripe' attribute.

Tried to add drop-downs for the expiry date and was told by Stripe support "The data-stripe version of Stripe.js doesn't support dropdowns yet. In the meantime, feel free to copy the old method from https://gist.github.com/boucher/1750368)"

2. https://gist.github.com/justinthiele/1307748

3. Create Test Cases Using https://stripe.com/docs/testing

4. Refer Daniel Kenahoe's purchased book on Stripe related features.





[Creating a Form for Handling Payments with Stripe] (http://www.larryullman.com/2012/11/28/creating-a-form-for-handling-payments-with-stripe/ 'Stripe')

Include the Stripe.js only on payment page.

<script type="text/javascript" src="https://js.stripe.com/v2/"></script>

<script type="text/javascript">// <![CDATA[
Stripe.setPublishableKey('your-stripe-key-here');
// ]]></script>
<script type="text/javascript" src="js/buy.js"></script>

This payment page must be loaded using https.

<label>Card Number</label>
<input type="text" size="20" autocomplete="off">
<span>Enter the number without spaces or hyphens.</span>
<label>Expiration (MM/YYYY)</label>
<input type="text" size="2">
<span> / </span>
<input type="text" size="4">

<form id="payment-form" action="buy.php" method="POST">
<div id="payment-errors"></div>
</form>

buy.js

$(document).ready(function() {
    // Watch for a form submission:
    $("#payment-form").submit(function(event) {
        $('#submitBtn').attr('disabled', 'disabled');
        return false;
    }); // form submission
}); // document ready.

var error = false;
 
// Get the values:
var ccNum = $('.card-number').val(),
    expMonth = $('.card-expiry-month').val(),
    expYear = $('.card-expiry-year').val();
 
// Validate the number:
if (!Stripe.validateCardNumber(ccNum)) {
    error = true;
    reportError('The credit card number appears to be invalid.');
}
  
// Validate the expiration:
if (!Stripe.validateExpiry(expMonth, expYear)) {
    error = true;
    reportError('The expiration date appears to be invalid.');
}

if (!error) {
    // Get the Stripe token:
    Stripe.createToken({
        number: ccNum,
        cvc: cvcNum,
        exp_month: expMonth,
        exp_year: expYear
    }, stripeResponseHandler);
}

function stripeResponseHandler(status, response) {
  if (response.error) {
      reportError(response.error.message);
  } else { // No errors, submit the form.
    // Get a reference to the form:
    var f = $("#payment-form");
 
    // Get the token from the response:
    var token = response.id;
 
    // Add the token to the form:
    f.append('<input type="hidden" name="stripeToken" value="' + token + '" />');
 
    // Submit the form:
    f.get(0).submit();
  }
} 


function reportError(msg) {
 
    // Show the error in the form:
    $('#payment-errors').text(msg).addClass('error');
 
    // Re-enable the submit button:
    $('#submitBtn').prop('disabled', false);
 
    return false;
 
}